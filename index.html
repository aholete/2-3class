<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PiQMap Web</title>
<style>
  body {
    font-family: "Arial", sans-serif;
    margin: 0;
    display: flex;
    flex-direction: column;
    height: 100vh;
  }
  #map {
    flex: 1;
  }
  #overlay {
    display: none;
    height: 300px;
    border-top: 2px solid #007BFF;
  }
  iframe {
    width: 100%;
    height: 100%;
    border: none;
  }
  #toggle {
    padding: 10px;
    background: #f0f0f0;
  }
  label {
    font-weight: bold;
  }
</style>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
/>
</head>
<body>
<div id="map"></div>
<div id="toggle">
  <label>
    <input type="checkbox" id="showOverlay" /> PiQMapを表示
  </label>
</div>
<div id="overlay">
  <iframe id="webFrame" src=""></iframe>
</div>

<script>
const map = L.map('map').setView([36.51294, 140.61616], 17);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19,
}).addTo(map);

const targets = [
  { lat: 36.5129744, lng: 140.6162104, url: "https://sites.google.com/view/piqmap/中高1号館" },
  { lat: 36.5130253, lng: 140.6167163, url: "https://sites.google.com/view/piqmap/中高2号館" },
  { lat: 36.5126087, lng: 140.6165638, url: "https://sites.google.com/view/piqmap/中高3号館" },
  { lat: 36.5124875, lng: 140.6162704, url: "https://sites.google.com/view/piqmap/中高4号館" },
  { lat: 36.5127208, lng: 140.6158962, url: "https://sites.google.com/view/piqmap/国際教育館" },
  { lat: 36.5133659, lng: 140.6164934, url: "https://sites.google.com/view/piqmap/中高5号館" },
  { lat: 36.5131515, lng: 140.6159549, url: "https://sites.google.com/view/piqmap/中高6号館" },
  { lat: 36.5135915, lng: 140.6160813, url: "https://sites.google.com/view/piqmap/学園講堂" },
  { lat: 36.5134390, lng: 140.6169192, url: "https://sites.google.com/view/piqmap/中高7号館" },
  { lat: 36.5141695, lng: 140.6161413, url: "https://sites.google.com/view/piqmap/高校テニスコート" },
  { lat: 36.5138478, lng: 140.6172826, url: "https://sites.google.com/view/piqmap/高校体育館" },
  { lat: 36.5126925, lng: 140.6183961, url: "https://sites.google.com/view/piqmap/正門" },
  { lat: 36.5127720, lng: 140.6170298, url: "https://sites.google.com/view/piqmap/生協" },
  { lat: 36.5110932, lng: 140.6164830, url: "https://sites.google.com/view/piqmap/キアラ館" },
  { lat: 36.5118141, lng: 140.6175210, url: "https://sites.google.com/view/piqmap/学園図書館" },
  { lat: 36.5105602, lng: 140.6167224, url: "https://sites.google.com/view/piqmap/学生食堂" },
  { lat: 36.5122118, lng: 140.6156595, url: "https://sites.google.com/view/piqmap/記念館" },
  { lat: 36.51222056, lng: 140.6182677, url: "https://sites.google.com/view/piqmap/大学11号館テラス" },
  { lat: 36.5144950, lng: 140.6169618, url: "https://sites.google.com/view/piqmap/本部" },
  { lat: 36.5112352, lng: 140.6175622, url: "https://sites.google.com/view/piqmap/シオン館" },
  { lat: 36.5103640, lng: 140.6174392, url: "https://sites.google.com/view/piqmap/モアヘッド記念館" },
  { lat: 36.50972, lng: 140.61667, url: "https://sites.google.com/view/piqmap/野球場" },
  { lat: 36.5102123, lng: 140.6158275, url: "https://sites.google.com/view/piqmap/若草寮" },
  { lat: 36.5106357, lng: 140.6174003, url: "https://sites.google.com/view/piqmap/大学8号館" },
  { lat: 36.5118790, lng: 140.6155083, url: "https://sites.google.com/view/piqmap/ゴルフ場" },
  { lat: 36.5137661, lng: 140.6168367, url: "https://sites.google.com/view/piqmap/カウンセリング研究所" },
  { lat: 36.5110153, lng: 140.6157997, url: "https://sites.google.com/view/piqmap/大学5号館" }
];

targets.forEach(t => {
  L.marker([t.lat, t.lng]).addTo(map);
});

const overlay = document.getElementById('overlay');
const webFrame = document.getElementById('webFrame');
const showOverlay = document.getElementById('showOverlay');
let tolerance = 30; // meters

showOverlay.addEventListener('change', () => {
  overlay.style.display = showOverlay.checked ? 'block' : 'none';
});

if (navigator.geolocation) {
  navigator.geolocation.watchPosition((pos) => {
    const { latitude, longitude } = pos.coords;
    map.setView([latitude, longitude], map.getZoom());
    checkNearest(latitude, longitude);
  }, err => {
    alert("位置情報が取得できませんでした: " + err.message);
  }, { enableHighAccuracy: true });
}

function checkNearest(lat, lng) {
  let closest = null;
  let minDist = Infinity;
  targets.forEach(t => {
    const dist = distance(lat, lng, t.lat, t.lng);
    if (dist < tolerance && dist < minDist) {
      minDist = dist;
      closest = t;
    }
  });
  if (closest && showOverlay.checked) {
    webFrame.src = closest.url;
    overlay.style.display = 'block';
  } else {
    overlay.style.display = 'none';
  }
}

// haversine distance (m)
function distance(lat1, lon1, lat2, lon2) {
  const R = 6371000;
  const toRad = x => x * Math.PI / 180;
  const dLat = toRad(lat2 - lat1);
  const dLon = toRad(lon2 - lon1);
  const a = Math.sin(dLat / 2) ** 2 +
            Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
            Math.sin(dLon / 2) ** 2;
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
}
</script>
</body>
</html>
